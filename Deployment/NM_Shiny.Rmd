---
title: "Human Development and Water in New Mexico"
resource_files:
- basic_count_long.RDS
- nm_census_tracts.RDS
- nm_connected_stream.RDS
- nm_county.RDS
- nm_disconnected_stream.RDS
- nm_npdes.RDS
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(tidyverse)
library(sf)
library(ggrepel)

# reading all inputs

# nm_counties <- readRDS("nm_county.RDS")
nm_census_tracts <- readRDS("nm_census_tracts.RDS")
nm_disconnected_stream <- readRDS("nm_disconnected_stream.RDS")
nm_connected_stream <- readRDS("nm_connected_stream.RDS")
HDI_indicators <- readRDS("HDI_indicators.RDS")
basic_count <- readRDS("basic_count_long.RDS")
nm_streams_summary_df <- readRDS("nm_streams_summary.RDS")
county_level_weighted <- readRDS("county_level_weighted.RDS")
nm_npdes <- readRDS("nm_npdes.RDS")
total_basic_count <- readRDS("state_total_basic_count.RDS")
nm_census_tracts_df <- readRDS("nm_census_tracts_df.RDS")
nm_surface_water_intake <- readRDS("nm_surface_water_intake.RDS")

# joining hdi_indicators to census_tract_shp
nm_census_tracts <- inner_join(nm_census_tracts, HDI_indicators)
 

# other county-level summary statistics weighted by population
fivenum_hdi <- fivenum(county_level_weighted$weighted_HDI)
fivenum_income <- fivenum(county_level_weighted$weighted_income)
fivenum_education <- fivenum(county_level_weighted$weighted_edn)
fivenum_expectancy <- fivenum(county_level_weighted$weighted_expectancy)
fivenum_disconnected <- fivenum(nm_streams_summary_df$length_unprotected)
fivenum_disconnected_pct <- fivenum(nm_streams_summary_df$pct_unprotected)

# color bins
bins <- c(0.5, 0.6, 0.7, 0.8, 0.9)
```

Statewide
==================

Column {data-width=200 .sidebar}
-----------------------------------------------------------------------

### New Mexico

```{r}
renderText(paste("In this dashboard, you will find information on the how each county and congressional district is affected by changes in the Clean Water Act. These legislative changes means that some waterways will no longer be protected. Some places will be more affected than others. This dashboard will not only show where, but also the socio-economic characteristics of each of these places using the Human Development Index (HDI).", "The HDI is a statistic used by the United Nations to rank countries into tiers of human development. It looks at life expectancy, education, and per capita income. This has been modified to for use in New Mexico where it is to rank and evaluate each county in terms of its human development.", sep = "\n"))
```

Column {data-width=600 .tabset}
-----------------------------------------------------------------------

### Unprotected Waterways
```{r}
renderLeaflet({
    pal <- colorBin("Blues", domain = nm_census_tracts$HDI, bins = bins)
    leaflet() %>%
      addProviderTiles(providers$Stamen.Toner, options = providerTileOptions(zIndex = 7)) %>%
      setView(lng = -105.87, lat = 34.52, zoom = 7) %>%
      # addPolygons(data = nm_counties, group = "County",  
      #             fillOpacity = 0, weight = 1.5, color = "white") %>%
      addPolygons(data = nm_census_tracts, label = ~round(HDI, 3), group = "HDI",
                  fillColor = ~pal(HDI), fillOpacity = 0.75, weight = 0, opacity = 0, color = "white") %>%
      addPolylines(data = st_zm(nm_disconnected_stream), label = ~GNIS_Name, group = "Unprotected Streams",
                   color = "#fb6a4a", weight = 1.2) %>%
      addPolylines(data = st_zm(nm_connected_stream), label = ~GNIS_Name, group = "Protected Streams",
                   color = "#08519c", weight = 1.2) %>%
      addCircleMarkers(data = nm_npdes, label = ~FACILITYNA, group = "Pollutant Sources", 
                       color = "#e41a1c", radius = 6, stroke = F, fillOpacity = 0.5, clusterOptions = markerClusterOptions()) %>%
      addCircleMarkers(data = nm_surface_water_intake, label = ~SYSTEM_NAM, group = "Public Water Sources",
                       color = "#525252", radius = 4, stroke = F, fillOpacity = 0.7, clusterOptions = markerClusterOptions()) %>%
      addLayersControl(overlayGroups = c("HDI", "Unprotected Streams", "Protected Streams", 
                                         "Pollutant Sources", "Public Water Sources"),
                       options = layersControlOptions(collapsed = FALSE)) %>%
      hideGroup(c("Unprotected Streams", "Protected Streams", "Pollutant Sources", "Public Water Sources")) %>%
      addLegend("bottomright", pal = pal, values = nm_census_tracts$HDI, title = "Human Development Index", opacity = 0.7)
   })
```

### Demographics
```{r}
ggplot(total_basic_count, aes(x = Race, y = value)) + 
    geom_point(col = "#fc8d62") + 
    geom_segment(aes(x = Race, xend = Race, y = 0, yend = value), col = "#969696") +
    scale_x_discrete(labels = c("Asian", "Biracial", "Black", "Hispanic", "Pacific Islander", "Native American", "Other", "White")) + 
    labs(x = "Race", y = "Est. % of State Totals", title = "Racial/Ethnic Composition of New Mexico") +
    theme(panel.background = element_rect(fill = "white"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    coord_flip()
```

### Vulnerability
```{r}
renderPlot({
  ggplot(nm_streams_summary_df, aes(x = `Public_Surface_Water_Pct`, y = pct_unprotected)) + 
    geom_point() + 
    geom_text_repel(aes(label = county_trunc), size = 2.0) + 
    labs(title = "At-Risk Counties", subtitle = "Counties are vulnerable when more of its population rely on (unprotected) self-supplied water sources.",
         x = "Population using  Surface Water (%)", y = "Unprotected Waterways (%) of County Total",
         colour = "Vulnerability Score")
   })
```

Column {data-width=200}
-----------------------------------------------------------------------

### Unprotected Waterways

```{r}
nm_disconnected_length <- nm_streams_summary_df$length_unprotected %>%
  unlist() %>%
  sum()

renderValueBox({
  valueBox(nm_disconnected_length,
           caption = "Unprotected Waterways (mi)",
           icon = 'fa-tint-slash',
           color = "primary")})
```

### State HDI

```{r}
nm_hdi <- HDI_indicators %>%
  ungroup() %>%
  mutate(total_state_pop = sum(Total_Pop)) %>%
  group_by(id) %>%
  mutate(weight_pop = Total_Pop/total_state_pop,
         weighted_HDI = weight_pop * HDI) %>%
  ungroup() %>%
  select(weighted_HDI) %>%
  unlist() %>%
  sum() %>%
  round(.,3)

renderValueBox({
  valueBox(nm_hdi,
           caption = "HDI",
           icon = 'fa-user',
           color = "primary")})
```

### Life Expectancy

```{r}
nm_life_exp <- nm_census_tracts_df %>%
  ungroup() %>%
  mutate(total_state_pop = sum(Total_Pop)) %>%
  group_by(id) %>%
  mutate(weight_pop = Total_Pop/total_state_pop,
         weighted_life_exp = weight_pop * `Life Expectancy`) %>%
  ungroup() %>%
  select(weighted_life_exp) %>% 
  unlist() %>%
  sum() %>%
  round(., 1)

renderValueBox({
  valueBox(nm_life_exp,
           caption = "Life Expectancy",
           icon = 'fa-heartbeat',
           color = "primary")})
```

### Years of Schooling

```{r}
nm_edn_yrs <- nm_census_tracts_df %>%
  ungroup() %>%
  mutate(total_state_pop = sum(Total_Pop)) %>%
  group_by(id) %>%
  mutate(weight_pop = Total_Pop/total_state_pop,
         weighted_years_ed = weight_pop * mean_years_ed) %>%
  ungroup() %>%
  select(weighted_years_ed) %>% 
  unlist() %>%
  sum() %>%
  round(., 1)

renderValueBox({
  valueBox(nm_edn_yrs,
           caption = "Years of Education for Adults",
           icon = 'fa-book',
           color = "primary")})
```

### Annual Income

```{r}
nm_income_pc <- nm_census_tracts_df %>%
  ungroup() %>%
  mutate(total_state_pop = sum(Total_Pop)) %>%
  group_by(id) %>%
  mutate(weight_pop = Total_Pop/total_state_pop,
         weighted_income_pc = weight_pop * income_per_capita) %>%
  ungroup() %>%
  select(weighted_income_pc) %>% 
  unlist() %>%
  sum() %>%
  round()

renderValueBox({
  valueBox(nm_income_pc,
           caption = "Mean Income per Capita ($)",
           icon = 'fa-dollar-sign',
           color = "primary")})
```

County
==================

Column {data-width=200 .sidebar}
-----------------------------------------------------------------------

### New Mexico

```{r}
selectInput("county",
            "County:",
            choices = sort(unique(nm_census_tracts$county)),
            "Taos County")
```


Column {data-width=600 .tabset}
-----------------------------------------------------------------------
### Unprotected Waterways

```{r}
reactive_county <- reactive({
    nm_census_tracts_filtered <- nm_census_tracts %>%
      filter(county == input$county)
    pal <- colorBin("Blues", domain = nm_census_tracts_filtered$HDI, bins = bins)
    # nm_counties_filtered <- nm_counties %>%
    #   filter(NAMELSAD == input$county)
    nm_streams_filtered <- nm_disconnected_stream %>%
      filter(NAMELSAD == input$county)
    nm_connected_streams_filtered <- nm_connected_stream %>%
      filter(NAMELSAD == input$county)
    leaflet() %>%
      addProviderTiles(providers$Stamen.Toner) %>%
      # addPolygons(data = nm_counties_filtered, group = "County",  
      #             fillOpacity = 0, weight = 1.5, color = "black") %>%
      addPolygons(data = nm_census_tracts_filtered, label = ~round(HDI, 3), group = "HDI",
                  fillColor = ~pal(HDI), fillOpacity = 0.5, weight = 0.75, opacity = 1, color = "white") %>%
      addPolylines(data = st_zm(nm_streams_filtered), label = ~GNIS_Name, group = "Unprotected Streams",
                   color = "#fb6a4a", weight = 1.2) %>%
      addPolylines(data = st_zm(nm_connected_streams_filtered), label = ~GNIS_Name, group = "Protected Streams",
                   color = "#08519c", weight = 1.2) %>%
      addLayersControl(overlayGroups = c("HDI", "Unprotected Streams", "Protected Streams"),
                       options = layersControlOptions(collapsed = FALSE)) %>%
      hideGroup(c("Unprotected Streams", "Protected Streams")) %>%
      addLegend("bottomright", pal = pal, values = nm_census_tracts_filtered$HDI, title = "HDI", opacity = 0.7)
  })
renderLeaflet({
     reactive_county()
   })
```

### Demographics
```{r}
demographics <- reactive({
  filtered_basic_count <- basic_count %>%
    filter(county == input$county)
  ggplot(filtered_basic_count, aes(x = Race, y = value)) + 
    geom_point(col = "#fc8d62") + 
    geom_segment(aes(x = Race, xend = Race, y = 0, yend = value), col = "#969696") +
    scale_x_discrete(labels = c("Asian", "Biracial", "Black", "Hispanic", "Pacific Islander", "Native American", "Other", "White")) + 
    labs(x = "Race", y = "Est. % of County Totals", title = paste("Population of", input$county, sep = " ")) +
    theme(panel.background = element_rect(fill = "white"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
    coord_flip()
})
renderPlot({
  demographics()
})
```


### Comparing County with NM

```{r}
disconnected_length <- reactive({
  nm_streams_summary_df %>% 
    ungroup() %>%
    filter(NAMELSAD == input$county) %>% 
    select(length_unprotected) %>% 
    unlist()})

reactive_county_hdi <- reactive({
    county_level_weighted %>% 
    filter(county == input$county) %>% 
    select(weighted_HDI) %>% 
    unlist()})

county_life_exp <- reactive({
  county_level_weighted %>% 
    filter(county == input$county) %>% 
    select(weighted_expectancy) %>% 
    unlist()})

education_yrs <- reactive({
  county_level_weighted %>% 
    filter(county == input$county) %>% 
    select(weighted_edn) %>% 
    unlist()})

income_pc <- reactive({
  county_level_weighted %>% 
    filter(county == input$county) %>% 
    select(weighted_income) %>% 
    unlist()})

comparison_plot_df_plot <- reactive({
  metric <- c("HDI", "Unprotected Waterways", "Life Expectancy", "Years of Education", "Income")
  disconnected_val <- round(100*disconnected_length()/fivenum_disconnected[3])-100
  hdi_val <- round(100*reactive_county_hdi()/fivenum_hdi[3])-100
  life_exp_val <- round(100*county_life_exp()/fivenum_expectancy[3])-100
  education_val <- round(100*education_yrs()/fivenum_education[3])-100
  income_val <- round(100*income_pc()/fivenum_income[3])-100
  values <- c(hdi_val, disconnected_val, life_exp_val, education_val, income_val)
  comparison_df <- cbind(metric, values) %>%
    as.data.frame()
  comparison_df <- comparison_df[order(comparison_df$values),]
  comparison_df$metric <- factor(comparison_df$metric, levels = comparison_df$metric)
  ggplot(comparison_df, aes(x = metric, y = as.numeric(values), label = values)) +
    geom_bar(stat = "identity", width = 0.5) + 
    labs(title = paste("Comparing", input$county, "Against NM Median", sep = " "),
         y = "% (Below [-ve] / Above [+ve]) State Median",
         x = "Metric") + 
    coord_flip()
})

renderPlot({
  comparison_plot_df_plot()
})
```


Column {data-width=200}
-----------------------------------------------------------------------
### Unprotected Waterways

```{r}
renderValueBox({
  valueBox(disconnected_length(),
           caption = "Unprotected Waterways (mi)",
           icon = 'fa-tint-slash',
           color = ifelse(disconnected_length() < fivenum_disconnected[3], "primary", 
                          ifelse(disconnected_length() > fivenum_disconnected[4], "danger", "warning")))})
```

### Unprotected Waterways_pct

```{r}
disconnected_pct <- reactive({
  nm_streams_summary_df %>% 
    ungroup() %>%
    filter(NAMELSAD == input$county) %>% 
    select(pct_unprotected) %>% 
    unlist()})

renderValueBox({
  valueBox(disconnected_pct(),
           caption = "Unprotected Waterways (% of Total)",
           icon = 'fa-tint-slash',
           color = ifelse(disconnected_pct() < fivenum_disconnected_pct[3], "primary", 
                          ifelse(disconnected_pct() > fivenum_disconnected_pct[4], "danger", "warning")))})
```

### County HDI

```{r}
renderValueBox({
  valueBox(reactive_county_hdi(),
           caption = "HDI",
           icon = 'fa-user',
           color = ifelse(reactive_county_hdi() > fivenum_hdi[3], "primary", 
                          ifelse(reactive_county_hdi() < fivenum_hdi[2], "danger", "warning"))
           )}
  )
```

### Mean Life Expectancy

```{r}
renderValueBox({
  valueBox(county_life_exp(),
           caption = "Life Expectancy",
           icon = 'fa-heartbeat',
           color = ifelse(county_life_exp() > fivenum_expectancy[3], "primary", 
                          ifelse(county_life_exp() < fivenum_expectancy[2], "danger", "warning")))})
```

### Mean Years of Schooling

```{r}
renderValueBox({
  valueBox(education_yrs(),
           caption = "Years of Education for Adults",
           icon = 'fa-book',
           color = ifelse(education_yrs() > fivenum_education[3], "primary", 
                          ifelse(education_yrs() < fivenum_education[2], "danger", "warning")))})
```

### Mean Annual Income

```{r}
renderValueBox({
  valueBox(income_pc(),
           caption = "Income per Capita ($)",
           icon = 'fa-dollar-sign',
           color = ifelse(income_pc() > fivenum_income[3], "primary", 
                          ifelse(income_pc() < fivenum_income[2], "danger", "warning")))})
```
